<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <main id="main-content" class="container mx-auto p-6">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4">Экспортировать цитаты Букмейт</h2>
        <p>
          Выберите книгу для которой нужно экспортировать Ваши цитаты, нажмите
          на кнопку "Поделиться" и "Скопировать ссылку", после чего вставьте
          полученную ссылку ниже:
        </p>
        <br />
        <div class="mb-4">
          <label
            for="url-id"
            class="block text-sm font-medium text-gray-700 mb-2"
            >Ссылка на книгу:</label
          >
          <input
            type="text"
            id="url-id"
            placeholder="https://bookmate.ru/books/uo8blm5h?username=b123456789&utm_source=direct_link&utm_medium=referral&utm_content=web&utm_campaign=users_referral"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          />
        </div>
        <div class="mb-4">
          <p id="book-id" class="block text-sm font-medium text-gray-700 mb-2"></p>
        </div>
        <div class="mb-4">
          <p
            id="user-id"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
          </p>
        </div>
        <button
          id="fetch-quotes"
          class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
        >
          Экспортировать цитаты
        </button>
        <div id="quotes" class="mt-6 space-y-4"></div>
      </div>
    </main>

    <script type="module">
      function extractBookAndUserId(url) {
        const urlObj = new URL(url);
        const bookId = urlObj.pathname.split("/").pop();
        const userId = urlObj.searchParams.get("username");

        return {
          bookId: bookId,
          userId: userId,
        };
      }

      async function getQuotes(bookId, userLogin) {
        let page = 1; // Инициализируем переменную страницы с 1
        const allQuotes = []; // Создаем пустой массив для хранения всех цитат

        try {
          // eslint-disable-next-line no-constant-condition
          while (true) {
            // Бесконечный цикл для выполнения запросов до тех пор, пока не будут получены все цитаты
            const response = await fetch(
              `https://bookmate.ru/p/api/v5/books/${bookId}/quotes?&page=${page}&per_page=1000&user_login=${userLogin}&lang=ru`
            );
            const reader = response.body.getReader(); // Получаем объект чтения потока
            const decoder = new TextDecoder(); // Создаем декодер текста
            let result = ""; // Инициализируем пустую строку для накопления результата

            let done, value;
            while (!done) {
              // Цикл чтения данных из потока
              ({ done, value } = await reader.read()); // Читаем следующую порцию данных
              if (value) {
                result += decoder.decode(value, { stream: true }); // Декодируем данные и добавляем их к результату
              }
            }

            console.log(`Stream complete for page ${page}`); // Логируем завершение чтения потока для текущей страницы

            // Парсим результат в JSON
            const data = JSON.parse(result);

            // Прерываем цикл, если массив цитат пуст
            if (data.quotes.length === 0) {
              break;
            }

            // Извлекаем свойство "content" из каждой цитаты и добавляем в массив allQuotes
            const contents = data.quotes.map((quote) => quote.content);
            allQuotes.push(...contents);

            // Увеличиваем номер страницы для следующего запроса
            page++;
          }

          return allQuotes; // Возвращаем объединенный массив всех цитат
        } catch (error) {
          console.error("Error:", error); // Логируем ошибку в случае возникновения
        }
      }

      // Обработчик нажатия на кнопку
      document
        .getElementById("fetch-quotes")
        .addEventListener("click", async () => {
          const urlId = document.getElementById("url-id").value;

          if (!urlId) {
            alert("Пожалуйста, вставьте ссылку на книгу");
            return;
          }

          const bookElement = document.getElementById("book-id");
          const userElement = document.getElementById("user-id");

          const { bookId, userId } = extractBookAndUserId(urlId);

          bookElement.textContent = `ID книги: ${bookId}`;
          userElement.textContent = `ID пользователя: ${userId}`;

          if(!bookId || !userId) {
            alert("Не удалось извлечь ID книги или ID пользователя");
            return;
          }

          const quotes = await getQuotes(bookId, userId);

          const quotesContainer = document.getElementById("quotes");
          quotesContainer.innerHTML = quotes
            .map((quote) => `<p>${quote}</p><br />`)
            .join("");
        });
    </script>
  </body>
</html>
